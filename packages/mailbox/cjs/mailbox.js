"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
var _utils = require("@resource/utils");
var _hub = require("@textile/hub");
let Mailbox = class Mailbox {
    static async createMailbox(user, config, parser) {
        const mb = new Mailbox(user, config);
        const mid = await mb.getUsersClient().setupMailbox();
        const callback = (reply)=>{
            if (!reply || !reply.message) return;
            mb.emitters.forEach(async (emitter)=>{
                if (reply.message) {
                    const dec = await mb.messageDecoder(mb.user, reply.message);
                    const parsed = await parser(dec);
                    emitter.emit('data', {
                        notification: parsed
                    });
                }
            });
        };
        mb.listener = await mb.getUsersClient().watchInbox(mid, callback);
        return mb;
    }
    subscribe(emitter) {
        this.emitters.push(emitter);
    }
    async listInboxMessages(seek, limit) {
        const res = await this.getUsersClient().listInboxMessages({
            seek,
            limit
        });
        const inbox = [];
        // eslint-disable-next-line no-restricted-syntax
        for (const msg of res){
            // eslint-disable-next-line no-await-in-loop
            const decryptedMsg = await this.messageDecoder(this.user, msg);
            inbox.push(decryptedMsg);
        }
        return inbox;
    }
    async sendMessage(to, body) {
        const toKey = (0, _utils).tryParsePublicKey(to);
        const res = await this.getUsersClient().sendMessage(this.user.identity, toKey, body);
        return res;
    }
    async deleteMessage(id) {
        await this.getUsersClient().deleteInboxMessage(id);
    }
    getUserAuth() {
        if (this.user.storageAuth === undefined) {
            throw new Error('Authentication Error');
        }
        return this.user.storageAuth;
    }
    getUsersClient() {
        return this.initUsers(this.getUserAuth());
    }
    initUsers(userAuth) {
        if (this.config?.usersInit) {
            return this.config.usersInit(userAuth);
        }
        return _hub.Users.withUserAuth(userAuth, {
            host: this.config?.textileHubAddress
        });
    }
    constructor(user1, config){
        this.user = user1;
        this.config = config;
        this.messageDecoder = async (user, message)=>{
            const identity = new _hub.PrivateKey(user.identity.privKey.slice(0, 32));
            const decryptedBody = await identity.decrypt(message.body);
            return {
                decryptedBody,
                ...message
            };
        };
        this.emitters = [];
    }
};
exports.Mailbox = Mailbox;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWlsYm94LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdycGMgfSBmcm9tICdAaW1wcm9iYWJsZS1lbmcvZ3JwYy13ZWInXG5pbXBvcnQgdHlwZSB7IElVc2VyIH0gZnJvbSAnQHJlc291cmNlL2lkZW50aXR5J1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uIH0gZnJvbSAnQHJlc291cmNlL3N0b3JhZ2UnXG5pbXBvcnQgeyB0cnlQYXJzZVB1YmxpY0tleSB9IGZyb20gJ0ByZXNvdXJjZS91dGlscydcbmltcG9ydCB7XG4gIElkZW50aXR5LFxuICBNYWlsYm94RXZlbnQsXG4gIFByaXZhdGVLZXksXG4gIFVzZXJBdXRoLFxuICBVc2VyTWVzc2FnZSxcbiAgVXNlcnNcbn0gZnJvbSAnQHRleHRpbGUvaHViJ1xuaW1wb3J0ICogYXMgZWUgZnJvbSAnZXZlbnQtZW1pdHRlcidcblxuXG5leHBvcnQgaW50ZXJmYWNlIE1haWxib3hDb25maWcge1xuICB0ZXh0aWxlSHViQWRkcmVzczogc3RyaW5nXG4gIHVzZXJzSW5pdD86IChhdXRoOiBVc2VyQXV0aCkgPT4gVXNlcnNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEZWNyeXB0ZWRVc2VyTWVzc2FnZSBleHRlbmRzIFVzZXJNZXNzYWdlIHtcbiAgZGVjcnlwdGVkQm9keTogVWludDhBcnJheVxufVxuXG5leHBvcnQgY2xhc3MgTWFpbGJveCB7XG4gIHByaXZhdGUgbGlzdGVuZXI/OiBncnBjLlJlcXVlc3RcblxuICBwcml2YXRlIGVtaXR0ZXJzOiBlZS5FbWl0dGVyW11cblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdXNlcjogSVVzZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IE1haWxib3hDb25maWdcbiAgKSB7XG4gICAgdGhpcy5lbWl0dGVycyA9IFtdXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZU1haWxib3goXG4gICAgdXNlcjogSVVzZXIsXG4gICAgY29uZmlnOiBNYWlsYm94Q29uZmlnLFxuICAgIHBhcnNlcjogKGRlYzogRGVjcnlwdGVkVXNlck1lc3NhZ2UpID0+IFByb21pc2U8Tm90aWZpY2F0aW9uPlxuICApOiBQcm9taXNlPE1haWxib3g+IHtcbiAgICBjb25zdCBtYiA9IG5ldyBNYWlsYm94KHVzZXIsIGNvbmZpZylcbiAgICBjb25zdCBtaWQgPSBhd2FpdCBtYi5nZXRVc2Vyc0NsaWVudCgpLnNldHVwTWFpbGJveCgpXG5cbiAgICBjb25zdCBjYWxsYmFjayA9IChyZXBseT86IE1haWxib3hFdmVudCkgPT4ge1xuICAgICAgaWYgKCFyZXBseSB8fCAhcmVwbHkubWVzc2FnZSkgcmV0dXJuXG5cbiAgICAgIG1iLmVtaXR0ZXJzLmZvckVhY2goYXN5bmMgKGVtaXR0ZXIpID0+IHtcbiAgICAgICAgaWYgKHJlcGx5Lm1lc3NhZ2UpIHtcbiAgICAgICAgICBjb25zdCBkZWMgPSBhd2FpdCBtYi5tZXNzYWdlRGVjb2RlcihtYi51c2VyLCByZXBseS5tZXNzYWdlKVxuICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IGF3YWl0IHBhcnNlcihkZWMpXG4gICAgICAgICAgZW1pdHRlci5lbWl0KCdkYXRhJywgeyBub3RpZmljYXRpb246IHBhcnNlZCB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIG1iLmxpc3RlbmVyID0gYXdhaXQgbWIuZ2V0VXNlcnNDbGllbnQoKS53YXRjaEluYm94KG1pZCwgY2FsbGJhY2spXG4gICAgcmV0dXJuIG1iXG4gIH1cblxuICBwdWJsaWMgc3Vic2NyaWJlKGVtaXR0ZXI6IGVlLkVtaXR0ZXIpOiB2b2lkIHtcbiAgICB0aGlzLmVtaXR0ZXJzLnB1c2goZW1pdHRlcilcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0SW5ib3hNZXNzYWdlcyhcbiAgICBzZWVrPzogc3RyaW5nLFxuICAgIGxpbWl0PzogbnVtYmVyXG4gICk6IFByb21pc2U8RGVjcnlwdGVkVXNlck1lc3NhZ2VbXT4ge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZ2V0VXNlcnNDbGllbnQoKS5saXN0SW5ib3hNZXNzYWdlcyh7XG4gICAgICBzZWVrLFxuICAgICAgbGltaXQsXG4gICAgfSlcblxuICAgIGNvbnN0IGluYm94OiBEZWNyeXB0ZWRVc2VyTWVzc2FnZVtdID0gW11cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1zeW50YXhcbiAgICBmb3IgKGNvbnN0IG1zZyBvZiByZXMpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1hd2FpdC1pbi1sb29wXG4gICAgICBjb25zdCBkZWNyeXB0ZWRNc2cgPSBhd2FpdCB0aGlzLm1lc3NhZ2VEZWNvZGVyKHRoaXMudXNlciwgbXNnKVxuICAgICAgaW5ib3gucHVzaChkZWNyeXB0ZWRNc2cpXG4gICAgfVxuXG4gICAgcmV0dXJuIGluYm94XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2VuZE1lc3NhZ2UodG86IHN0cmluZywgYm9keTogVWludDhBcnJheSk6IFByb21pc2U8VXNlck1lc3NhZ2U+IHtcbiAgICBjb25zdCB0b0tleSA9IHRyeVBhcnNlUHVibGljS2V5KHRvKVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZ2V0VXNlcnNDbGllbnQoKS5zZW5kTWVzc2FnZShcbiAgICAgICh0aGlzLnVzZXIgYXMgYW55KS5pZGVudGl0eSBhcyBJZGVudGl0eSxcbiAgICAgIHRvS2V5LFxuICAgICAgYm9keVxuICAgIClcbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlTWVzc2FnZShpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5nZXRVc2Vyc0NsaWVudCgpLmRlbGV0ZUluYm94TWVzc2FnZShpZClcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VXNlckF1dGgoKTogVXNlckF1dGgge1xuICAgIGlmICh0aGlzLnVzZXIuc3RvcmFnZUF1dGggPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdXRoZW50aWNhdGlvbiBFcnJvcicpXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudXNlci5zdG9yYWdlQXV0aFxuICB9XG5cbiAgcHJpdmF0ZSBnZXRVc2Vyc0NsaWVudCgpOiBVc2VycyB7XG4gICAgcmV0dXJuIHRoaXMuaW5pdFVzZXJzKHRoaXMuZ2V0VXNlckF1dGgoKSlcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFVzZXJzKHVzZXJBdXRoOiBVc2VyQXV0aCk6IFVzZXJzIHtcbiAgICBpZiAodGhpcy5jb25maWc/LnVzZXJzSW5pdCkge1xuICAgICAgcmV0dXJuIHRoaXMuY29uZmlnLnVzZXJzSW5pdCh1c2VyQXV0aClcbiAgICB9XG5cbiAgICByZXR1cm4gVXNlcnMud2l0aFVzZXJBdXRoKHVzZXJBdXRoLCB7XG4gICAgICBob3N0OiB0aGlzLmNvbmZpZz8udGV4dGlsZUh1YkFkZHJlc3MsXG4gICAgfSlcbiAgfVxuXG4gIG1lc3NhZ2VEZWNvZGVyID0gYXN5bmMgKFxuICAgIHVzZXI6IElVc2VyLFxuICAgIG1lc3NhZ2U6IFVzZXJNZXNzYWdlXG4gICk6IFByb21pc2U8RGVjcnlwdGVkVXNlck1lc3NhZ2U+ID0+IHtcbiAgICBjb25zdCBpZGVudGl0eSA9IG5ldyBQcml2YXRlS2V5KCh1c2VyLmlkZW50aXR5IGFzIGFueSkucHJpdktleS5zbGljZSgwLCAzMikpXG4gICAgY29uc3QgZGVjcnlwdGVkQm9keSA9IGF3YWl0IGlkZW50aXR5LmRlY3J5cHQobWVzc2FnZS5ib2R5KVxuICAgIHJldHVybiB7IGRlY3J5cHRlZEJvZHksIC4uLm1lc3NhZ2UgfVxuICB9XG59XG4iXSwibmFtZXMiOlsiTWFpbGJveCIsImNyZWF0ZU1haWxib3giLCJ1c2VyIiwiY29uZmlnIiwicGFyc2VyIiwibWIiLCJtaWQiLCJnZXRVc2Vyc0NsaWVudCIsInNldHVwTWFpbGJveCIsImNhbGxiYWNrIiwicmVwbHkiLCJtZXNzYWdlIiwiZW1pdHRlcnMiLCJmb3JFYWNoIiwiZW1pdHRlciIsImRlYyIsIm1lc3NhZ2VEZWNvZGVyIiwicGFyc2VkIiwiZW1pdCIsIm5vdGlmaWNhdGlvbiIsImxpc3RlbmVyIiwid2F0Y2hJbmJveCIsInN1YnNjcmliZSIsInB1c2giLCJsaXN0SW5ib3hNZXNzYWdlcyIsInNlZWsiLCJsaW1pdCIsInJlcyIsImluYm94IiwibXNnIiwiZGVjcnlwdGVkTXNnIiwic2VuZE1lc3NhZ2UiLCJ0byIsImJvZHkiLCJ0b0tleSIsInRyeVBhcnNlUHVibGljS2V5IiwiaWRlbnRpdHkiLCJkZWxldGVNZXNzYWdlIiwiaWQiLCJkZWxldGVJbmJveE1lc3NhZ2UiLCJnZXRVc2VyQXV0aCIsInN0b3JhZ2VBdXRoIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJpbml0VXNlcnMiLCJ1c2VyQXV0aCIsInVzZXJzSW5pdCIsIlVzZXJzIiwid2l0aFVzZXJBdXRoIiwiaG9zdCIsInRleHRpbGVIdWJBZGRyZXNzIiwiUHJpdmF0ZUtleSIsInByaXZLZXkiLCJzbGljZSIsImRlY3J5cHRlZEJvZHkiLCJkZWNyeXB0Il0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUdrQyxJQUFBLE1BQWlCLFdBQWpCLGlCQUFpQixDQUFBO0FBUTVDLElBQUEsSUFBYyxXQUFkLGNBQWMsQ0FBQTtBQWFkLElBQUEsQUFBTUEsT0FBTyxHQUFiLE1BQU1BLE9BQU87SUFZbEIsYUFBb0JDLGFBQWEsQ0FDL0JDLElBQVcsRUFDWEMsTUFBcUIsRUFDckJDLE1BQTRELEVBQzFDO1FBQ2xCLE1BQU1DLEVBQUUsR0FBRyxJQUFJTCxPQUFPLENBQUNFLElBQUksRUFBRUMsTUFBTSxDQUFDO1FBQ3BDLE1BQU1HLEdBQUcsR0FBRyxNQUFNRCxFQUFFLENBQUNFLGNBQWMsRUFBRSxDQUFDQyxZQUFZLEVBQUU7UUFFcEQsTUFBTUMsUUFBUSxHQUFHLENBQUNDLEtBQW9CLEdBQUs7WUFDekMsSUFBSSxDQUFDQSxLQUFLLElBQUksQ0FBQ0EsS0FBSyxDQUFDQyxPQUFPLEVBQUUs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