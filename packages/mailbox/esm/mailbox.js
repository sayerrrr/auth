import { tryParsePublicKey } from '@resource/utils';
import { PrivateKey, Users } from '@textile/hub';
export class Mailbox {
    static async createMailbox(user, config, parser) {
        const mb = new Mailbox(user, config);
        const mid = await mb.getUsersClient().setupMailbox();
        const callback = (reply)=>{
            if (!reply || !reply.message) return;
            mb.emitters.forEach(async (emitter)=>{
                if (reply.message) {
                    const dec = await mb.messageDecoder(mb.user, reply.message);
                    const parsed = await parser(dec);
                    emitter.emit('data', {
                        notification: parsed
                    });
                }
            });
        };
        mb.listener = await mb.getUsersClient().watchInbox(mid, callback);
        return mb;
    }
    subscribe(emitter) {
        this.emitters.push(emitter);
    }
    async listInboxMessages(seek, limit) {
        const res = await this.getUsersClient().listInboxMessages({
            seek,
            limit
        });
        const inbox = [];
        // eslint-disable-next-line no-restricted-syntax
        for (const msg of res){
            // eslint-disable-next-line no-await-in-loop
            const decryptedMsg = await this.messageDecoder(this.user, msg);
            inbox.push(decryptedMsg);
        }
        return inbox;
    }
    async sendMessage(to, body) {
        const toKey = tryParsePublicKey(to);
        const res = await this.getUsersClient().sendMessage(this.user.identity, toKey, body);
        return res;
    }
    async deleteMessage(id) {
        await this.getUsersClient().deleteInboxMessage(id);
    }
    getUserAuth() {
        if (this.user.storageAuth === undefined) {
            throw new Error('Authentication Error');
        }
        return this.user.storageAuth;
    }
    getUsersClient() {
        return this.initUsers(this.getUserAuth());
    }
    initUsers(userAuth) {
        if (this.config?.usersInit) {
            return this.config.usersInit(userAuth);
        }
        return Users.withUserAuth(userAuth, {
            host: this.config?.textileHubAddress
        });
    }
    constructor(user1, config){
        this.user = user1;
        this.config = config;
        this.messageDecoder = async (user, message)=>{
            const identity = new PrivateKey(user.identity.privKey.slice(0, 32));
            const decryptedBody = await identity.decrypt(message.body);
            return {
                decryptedBody,
                ...message
            };
        };
        this.emitters = [];
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWlsYm94LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdycGMgfSBmcm9tICdAaW1wcm9iYWJsZS1lbmcvZ3JwYy13ZWInXG5pbXBvcnQgdHlwZSB7IElVc2VyIH0gZnJvbSAnQHJlc291cmNlL2lkZW50aXR5J1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uIH0gZnJvbSAnQHJlc291cmNlL3N0b3JhZ2UnXG5pbXBvcnQgeyB0cnlQYXJzZVB1YmxpY0tleSB9IGZyb20gJ0ByZXNvdXJjZS91dGlscydcbmltcG9ydCB7XG4gIElkZW50aXR5LFxuICBNYWlsYm94RXZlbnQsXG4gIFByaXZhdGVLZXksXG4gIFVzZXJBdXRoLFxuICBVc2VyTWVzc2FnZSxcbiAgVXNlcnNcbn0gZnJvbSAnQHRleHRpbGUvaHViJ1xuaW1wb3J0ICogYXMgZWUgZnJvbSAnZXZlbnQtZW1pdHRlcidcblxuXG5leHBvcnQgaW50ZXJmYWNlIE1haWxib3hDb25maWcge1xuICB0ZXh0aWxlSHViQWRkcmVzczogc3RyaW5nXG4gIHVzZXJzSW5pdD86IChhdXRoOiBVc2VyQXV0aCkgPT4gVXNlcnNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEZWNyeXB0ZWRVc2VyTWVzc2FnZSBleHRlbmRzIFVzZXJNZXNzYWdlIHtcbiAgZGVjcnlwdGVkQm9keTogVWludDhBcnJheVxufVxuXG5leHBvcnQgY2xhc3MgTWFpbGJveCB7XG4gIHByaXZhdGUgbGlzdGVuZXI/OiBncnBjLlJlcXVlc3RcblxuICBwcml2YXRlIGVtaXR0ZXJzOiBlZS5FbWl0dGVyW11cblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdXNlcjogSVVzZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IE1haWxib3hDb25maWdcbiAgKSB7XG4gICAgdGhpcy5lbWl0dGVycyA9IFtdXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZU1haWxib3goXG4gICAgdXNlcjogSVVzZXIsXG4gICAgY29uZmlnOiBNYWlsYm94Q29uZmlnLFxuICAgIHBhcnNlcjogKGRlYzogRGVjcnlwdGVkVXNlck1lc3NhZ2UpID0+IFByb21pc2U8Tm90aWZpY2F0aW9uPlxuICApOiBQcm9taXNlPE1haWxib3g+IHtcbiAgICBjb25zdCBtYiA9IG5ldyBNYWlsYm94KHVzZXIsIGNvbmZpZylcbiAgICBjb25zdCBtaWQgPSBhd2FpdCBtYi5nZXRVc2Vyc0NsaWVudCgpLnNldHVwTWFpbGJveCgpXG5cbiAgICBjb25zdCBjYWxsYmFjayA9IChyZXBseT86IE1haWxib3hFdmVudCkgPT4ge1xuICAgICAgaWYgKCFyZXBseSB8fCAhcmVwbHkubWVzc2FnZSkgcmV0dXJuXG5cbiAgICAgIG1iLmVtaXR0ZXJzLmZvckVhY2goYXN5bmMgKGVtaXR0ZXIpID0+IHtcbiAgICAgICAgaWYgKHJlcGx5Lm1lc3NhZ2UpIHtcbiAgICAgICAgICBjb25zdCBkZWMgPSBhd2FpdCBtYi5tZXNzYWdlRGVjb2RlcihtYi51c2VyLCByZXBseS5tZXNzYWdlKVxuICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IGF3YWl0IHBhcnNlcihkZWMpXG4gICAgICAgICAgZW1pdHRlci5lbWl0KCdkYXRhJywgeyBub3RpZmljYXRpb246IHBhcnNlZCB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIG1iLmxpc3RlbmVyID0gYXdhaXQgbWIuZ2V0VXNlcnNDbGllbnQoKS53YXRjaEluYm94KG1pZCwgY2FsbGJhY2spXG4gICAgcmV0dXJuIG1iXG4gIH1cblxuICBwdWJsaWMgc3Vic2NyaWJlKGVtaXR0ZXI6IGVlLkVtaXR0ZXIpOiB2b2lkIHtcbiAgICB0aGlzLmVtaXR0ZXJzLnB1c2goZW1pdHRlcilcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsaXN0SW5ib3hNZXNzYWdlcyhcbiAgICBzZWVrPzogc3RyaW5nLFxuICAgIGxpbWl0PzogbnVtYmVyXG4gICk6IFByb21pc2U8RGVjcnlwdGVkVXNlck1lc3NhZ2VbXT4ge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZ2V0VXNlcnNDbGllbnQoKS5saXN0SW5ib3hNZXNzYWdlcyh7XG4gICAgICBzZWVrLFxuICAgICAgbGltaXQsXG4gICAgfSlcblxuICAgIGNvbnN0IGluYm94OiBEZWNyeXB0ZWRVc2VyTWVzc2FnZVtdID0gW11cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1zeW50YXhcbiAgICBmb3IgKGNvbnN0IG1zZyBvZiByZXMpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1hd2FpdC1pbi1sb29wXG4gICAgICBjb25zdCBkZWNyeXB0ZWRNc2cgPSBhd2FpdCB0aGlzLm1lc3NhZ2VEZWNvZGVyKHRoaXMudXNlciwgbXNnKVxuICAgICAgaW5ib3gucHVzaChkZWNyeXB0ZWRNc2cpXG4gICAgfVxuXG4gICAgcmV0dXJuIGluYm94XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2VuZE1lc3NhZ2UodG86IHN0cmluZywgYm9keTogVWludDhBcnJheSk6IFByb21pc2U8VXNlck1lc3NhZ2U+IHtcbiAgICBjb25zdCB0b0tleSA9IHRyeVBhcnNlUHVibGljS2V5KHRvKVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZ2V0VXNlcnNDbGllbnQoKS5zZW5kTWVzc2FnZShcbiAgICAgICh0aGlzLnVzZXIgYXMgYW55KS5pZGVudGl0eSBhcyBJZGVudGl0eSxcbiAgICAgIHRvS2V5LFxuICAgICAgYm9keVxuICAgIClcbiAgICByZXR1cm4gcmVzXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVsZXRlTWVzc2FnZShpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5nZXRVc2Vyc0NsaWVudCgpLmRlbGV0ZUluYm94TWVzc2FnZShpZClcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VXNlckF1dGgoKTogVXNlckF1dGgge1xuICAgIGlmICh0aGlzLnVzZXIuc3RvcmFnZUF1dGggPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdXRoZW50aWNhdGlvbiBFcnJvcicpXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudXNlci5zdG9yYWdlQXV0aFxuICB9XG5cbiAgcHJpdmF0ZSBnZXRVc2Vyc0NsaWVudCgpOiBVc2VycyB7XG4gICAgcmV0dXJuIHRoaXMuaW5pdFVzZXJzKHRoaXMuZ2V0VXNlckF1dGgoKSlcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFVzZXJzKHVzZXJBdXRoOiBVc2VyQXV0aCk6IFVzZXJzIHtcbiAgICBpZiAodGhpcy5jb25maWc/LnVzZXJzSW5pdCkge1xuICAgICAgcmV0dXJuIHRoaXMuY29uZmlnLnVzZXJzSW5pdCh1c2VyQXV0aClcbiAgICB9XG5cbiAgICByZXR1cm4gVXNlcnMud2l0aFVzZXJBdXRoKHVzZXJBdXRoLCB7XG4gICAgICBob3N0OiB0aGlzLmNvbmZpZz8udGV4dGlsZUh1YkFkZHJlc3MsXG4gICAgfSlcbiAgfVxuXG4gIG1lc3NhZ2VEZWNvZGVyID0gYXN5bmMgKFxuICAgIHVzZXI6IElVc2VyLFxuICAgIG1lc3NhZ2U6IFVzZXJNZXNzYWdlXG4gICk6IFByb21pc2U8RGVjcnlwdGVkVXNlck1lc3NhZ2U+ID0+IHtcbiAgICBjb25zdCBpZGVudGl0eSA9IG5ldyBQcml2YXRlS2V5KCh1c2VyLmlkZW50aXR5IGFzIGFueSkucHJpdktleS5zbGljZSgwLCAzMikpXG4gICAgY29uc3QgZGVjcnlwdGVkQm9keSA9IGF3YWl0IGlkZW50aXR5LmRlY3J5cHQobWVzc2FnZS5ib2R5KVxuICAgIHJldHVybiB7IGRlY3J5cHRlZEJvZHksIC4uLm1lc3NhZ2UgfVxuICB9XG59XG4iXSwibmFtZXMiOlsidHJ5UGFyc2VQdWJsaWNLZXkiLCJQcml2YXRlS2V5IiwiVXNlcnMiLCJNYWlsYm94IiwiY3JlYXRlTWFpbGJveCIsInVzZXIiLCJjb25maWciLCJwYXJzZXIiLCJtYiIsIm1pZCIsImdldFVzZXJzQ2xpZW50Iiwic2V0dXBNYWlsYm94IiwiY2FsbGJhY2siLCJyZXBseSIsIm1lc3NhZ2UiLCJlbWl0dGVycyIsImZvckVhY2giLCJlbWl0dGVyIiwiZGVjIiwibWVzc2FnZURlY29kZXIiLCJwYXJzZWQiLCJlbWl0Iiwibm90aWZpY2F0aW9uIiwibGlzdGVuZXIiLCJ3YXRjaEluYm94Iiwic3Vic2NyaWJlIiwicHVzaCIsImxpc3RJbmJveE1lc3NhZ2VzIiwic2VlayIsImxpbWl0IiwicmVzIiwiaW5ib3giLCJtc2ciLCJkZWNyeXB0ZWRNc2ciLCJzZW5kTWVzc2FnZSIsInRvIiwiYm9keSIsInRvS2V5IiwiaWRlbnRpdHkiLCJkZWxldGVNZXNzYWdlIiwiaWQiLCJkZWxldGVJbmJveE1lc3NhZ2UiLCJnZXRVc2VyQXV0aCIsInN0b3JhZ2VBdXRoIiwidW5kZWZpbmVkIiwiRXJyb3IiLCJpbml0VXNlcnMiLCJ1c2VyQXV0aCIsInVzZXJzSW5pdCIsIndpdGhVc2VyQXV0aCIsImhvc3QiLCJ0ZXh0aWxlSHViQWRkcmVzcyIsInByaXZLZXkiLCJzbGljZSIsImRlY3J5cHRlZEJvZHkiLCJkZWNyeXB0Il0sIm1hcHBpbmdzIjoiQUFHQSxTQUFTQSxpQkFBaUIsUUFBUSxpQkFBaUIsQ0FBQTtBQUNuRCxTQUdFQyxVQUFVLEVBR1ZDLEtBQUssUUFDQSxjQUFjLENBQUE7QUFhckIsT0FBTyxNQUFNQyxPQUFPO0lBWWxCLGFBQW9CQyxhQUFhLENBQy9CQyxJQUFXLEVBQ1hDLE1BQXFCLEVBQ3JCQyxNQUE0RCxFQUMxQztRQUNsQixNQUFNQyxFQUFFLEdBQUcsSUFBSUwsT0FBTyxDQUFDRSxJQUFJLEVBQUVDLE1BQU0sQ0FBQztRQUNwQyxNQUFNRyxHQUFHLEdBQUcsTUFBTUQsRUFBRSxDQUFDRSxjQUFjLEVBQUUsQ0FBQ0MsWUFBWSxFQUFFO1FBRXBELE1BQU1DLFFBQVEsR0FBRyxDQUFDQyxLQUFvQixHQUFLO1lBQ3pDLElBQUksQ0FBQ0EsS0FBSyxJQUFJLENBQUNBLEtBQUssQ0FBQ0MsT0FBTyxFQUFFLE9BQU07WUFFcENO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